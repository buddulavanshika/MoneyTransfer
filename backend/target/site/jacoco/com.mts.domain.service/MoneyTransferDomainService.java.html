<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyTransferDomainService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.mts.domain.service</a> &gt; <span class="el_source">MoneyTransferDomainService.java</span></div><h1>MoneyTransferDomainService.java</h1><pre class="source lang-java linenums">package com.mts.domain.service;

import com.mts.domain.enums.AccountStatus;
import com.mts.domain.enums.TransactionStatus;
import com.mts.domain.exceptions.AccountNotActiveException;
import com.mts.domain.exceptions.AccountNotFoundException;
import com.mts.domain.exceptions.DuplicateTransferException;
import com.mts.domain.exceptions.InsufficientBalanceException;
import com.mts.domain.model.Account;
import com.mts.domain.model.TransactionLog;
import com.mts.domain.util.Money;

import java.time.Instant;
import java.util.Objects;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Pure domain service that orchestrates money transfer using domain rules.
 *
 * &lt;p&gt;Responsibilities:
 * &lt;ul&gt;
 *   &lt;li&gt;Validate inputs (accounts, status, amount)&lt;/li&gt;
 *   &lt;li&gt;Enforce idempotency (in-memory for Module 2)&lt;/li&gt;
 *   &lt;li&gt;Execute business sequence: debit (source) â†’ credit (destination)&lt;/li&gt;
 *   &lt;li&gt;Return a SUCCESS {@link TransactionLog} on completion&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Notes:
 * &lt;ul&gt;
 *   &lt;li&gt;Failures are represented via domain exceptions; this service does not create failure logs.&lt;/li&gt;
 *   &lt;li&gt;In Module 3, idempotency should be persisted (e.g., DB unique constraint) and the service
 *       will be wrapped in a transactional application/service layer.&lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="fc" id="L37">public class MoneyTransferDomainService {</span>

    /**
     * In-memory idempotency store for Module 2 (test-friendly).
     * Replaced by persistent uniqueness in Module 3.
     */
<span class="fc" id="L43">    private final Set&lt;String&gt; usedIdempotencyKeys = ConcurrentHashMap.newKeySet();</span>

    /**
     * Execute a transfer with an explicit idempotency key.
     *
     * @param from           Source account (must be ACTIVE)
     * @param to             Destination account (must be ACTIVE)
     * @param amount         Money to transfer (must be &gt; 0)
     * @param idempotencyKey Unique key per request; must not repeat
     * @return Success {@link TransactionLog}
     *
     * @throws AccountNotFoundException     if any account is null
     * @throws AccountNotActiveException    if any account is not ACTIVE
     * @throws IllegalArgumentException     if accounts are same or amount invalid or key blank
     * @throws DuplicateTransferException   if idempotency key was already used
     * @throws InsufficientBalanceException if source balance is insufficient (mapped here)
     */
    public TransactionLog transfer(Account from, Account to, Money amount, String idempotencyKey) {
<span class="fc" id="L61">        validateInputs(from, to, amount, idempotencyKey);</span>
<span class="fc" id="L62">        enforceIdempotency(idempotencyKey);</span>

        // Debit first; translate insufficient funds into the domain exception expected by tests
        try {
<span class="fc" id="L66">            from.debit(amount.getAmount());</span>
<span class="fc" id="L67">        } catch (IllegalStateException ex) {</span>
            // Only map the insufficient funds case; keep other IllegalStateExceptions as-is
<span class="pc bpc" id="L69" title="2 of 4 branches missed.">            if (ex.getMessage() != null &amp;&amp; ex.getMessage().startsWith(&quot;Insufficient balance&quot;)) {</span>
<span class="fc" id="L70">                throw new InsufficientBalanceException(ex.getMessage());</span>
            }
<span class="nc" id="L72">            throw ex;</span>
<span class="fc" id="L73">        }</span>

        // Credit only after a successful debit
<span class="fc" id="L76">        to.credit(amount.getAmount());</span>

        // Build success transaction log
<span class="fc" id="L79">        TransactionLog log = new TransactionLog();</span>
<span class="fc" id="L80">        log.setId(UUID.randomUUID().toString());</span>
<span class="fc" id="L81">        log.setFromAccountId(from.getId());</span>
<span class="fc" id="L82">        log.setToAccountId(to.getId());</span>
<span class="fc" id="L83">        log.setAmount(amount.getAmount());</span>
<span class="fc" id="L84">        log.setStatus(TransactionStatus.SUCCESS);</span>
<span class="fc" id="L85">        log.setFailureReason(null);</span>
<span class="fc" id="L86">        log.setIdempotencyKey(idempotencyKey);</span>
<span class="fc" id="L87">        log.setCreatedOn(Instant.now());</span>

<span class="fc" id="L89">        return log;</span>
    }

    /**
     * Execute a transfer using an auto-generated idempotency key.
     * Useful for internal flows or tests where explicit keying isn't required.
     */
    public TransactionLog transfer(Account from, Account to, Money amount) {
<span class="fc" id="L97">        String autoKey = &quot;AUTO-&quot; + UUID.randomUUID();</span>
<span class="fc" id="L98">        return transfer(from, to, amount, autoKey);</span>
    }

    /* =========================
       Validation &amp; Idempotency
       ========================= */

    private void validateInputs(Account from, Account to, Money amount, String idempotencyKey) {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (from == null) {</span>
<span class="fc" id="L107">            throw new AccountNotFoundException(&quot;Source account not found&quot;);</span>
        }
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (to == null) {</span>
<span class="fc" id="L110">            throw new AccountNotFoundException(&quot;Destination account not found&quot;);</span>
        }
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (Objects.equals(from.getId(), to.getId())) {</span>
<span class="fc" id="L113">            throw new IllegalArgumentException(&quot;Accounts must be different&quot;);</span>
        }
<span class="fc" id="L115">        ensureActive(from);</span>
<span class="fc" id="L116">        ensureActive(to);</span>

<span class="pc bpc" id="L118" title="1 of 4 branches missed.">        if (amount == null || !amount.isPositive()) {</span>
<span class="fc" id="L119">            throw new IllegalArgumentException(&quot;Amount must be &gt; 0&quot;);</span>
        }
<span class="pc bpc" id="L121" title="2 of 4 branches missed.">        if (idempotencyKey == null || idempotencyKey.isBlank()) {</span>
<span class="nc" id="L122">            throw new IllegalArgumentException(&quot;Idempotency key must be provided&quot;);</span>
        }

        // If your Account tracks currency, enforce matching currency here.
        // Example:
        // if (!Objects.equals(from.getCurrency(), amount.getCurrency()) ||
        //     !Objects.equals(to.getCurrency(), amount.getCurrency())) { ... }
<span class="fc" id="L129">    }</span>

    private void ensureActive(Account account) {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (account.getStatus() != AccountStatus.ACTIVE) {</span>
<span class="fc" id="L133">            throw new AccountNotActiveException(&quot;Account &quot; + account.getId() + &quot; is not ACTIVE&quot;);</span>
        }
<span class="fc" id="L135">    }</span>

    private void enforceIdempotency(String idempotencyKey) {
<span class="fc" id="L138">        boolean firstUse = usedIdempotencyKeys.add(idempotencyKey);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (!firstUse) {</span>
<span class="fc" id="L140">            throw new DuplicateTransferException(&quot;Duplicate transfer request (idempotency)&quot;);</span>
        }
<span class="fc" id="L142">    }</span>

    /**
     * Test support: clears in-memory idempotency keys between tests.
     * Not intended for production usage.
     */
    public void resetIdempotencyKeys() {
<span class="fc" id="L149">        usedIdempotencyKeys.clear();</span>
<span class="fc" id="L150">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>