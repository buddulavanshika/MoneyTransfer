<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransferController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.mts.application.controller</a> &gt; <span class="el_source">TransferController.java</span></div><h1>TransferController.java</h1><pre class="source lang-java linenums">package com.mts.application.controller;

import com.mts.application.entities.TransactionLog;
import com.mts.application.service.TransferService;
import com.mts.domain.dto.TransferRequest;
import com.mts.domain.dto.TransferResponse;
import com.mts.domain.enums.TransactionStatus;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.enums.ParameterIn;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springdoc.core.annotations.ParameterObject;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.web.PageableDefault;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.OffsetDateTime;

@RestController
@RequestMapping(&quot;/api/v1&quot;) // ⬅️ moved here so we can expose both /transfers and /accounts/{id}/transactions
@Tag(name = &quot;Transfers&quot;, description = &quot;Endpoints for executing fund transfers and querying transaction history&quot;)
@RequiredArgsConstructor
public class TransferController {

    private final TransferService transferService;
    private final TransferService txQueryService; // ⬅️ service used for history queries

    // -------------------------
    // POST /api/v1/transfers
    // -------------------------
    @Operation(
            summary = &quot;Execute a fund transfer&quot;,
            description = &quot;Debits the source account and credits the destination account atomically. &quot;
                    + &quot;Validates account status, balance, and enforces idempotency if header is provided.&quot;,
            responses = {
                    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Transfer successful&quot;,
                            content = @Content(schema = @Schema(implementation = TransferResponse.class))),
                    @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid request or insufficient funds&quot;, content = @Content),
                    @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Account not active&quot;, content = @Content),
                    @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Account not found&quot;, content = @Content),
                    @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Duplicate transfer (idempotency)&quot;, content = @Content)
            }
    )
    @PostMapping(&quot;/transfers&quot;)
    public ResponseEntity&lt;TransferResponse&gt; executeTransfer(
            @Valid @RequestBody
            @Parameter(description = &quot;Transfer details (from, to, amount, currency, idempotencyKey)&quot;)
            TransferRequest request,

            @RequestHeader(value = &quot;Idempotency-Key&quot;, required = false)
            @Parameter(description = &quot;Optional idempotency key header to prevent duplicate transfers&quot;)
            String idempotencyKey
    ) {
        // If your TransferService accepts the header, pass it along; else request already carries the key.
        // e.g., transferService.transfer(request, idempotencyKey);
<span class="nc" id="L64">        TransferResponse response = transferService.transfer(request);</span>
<span class="nc" id="L65">        return ResponseEntity.ok(response);</span>
    }

    // ----------------------------------------------------------
    // GET /api/v1/accounts/{id}/transactions (history endpoint)
    // ----------------------------------------------------------
    @Operation(
            summary = &quot;Get transaction history for an account&quot;,
            description = &quot;Returns paginated transactions where the account is either sender or receiver. &quot;
                    + &quot;Supports date range, status, and direction filters.&quot;,
            responses = {
                    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Page of transactions&quot;,
                            content = @Content(schema = @Schema(implementation = TransactionLog.class))),
                    @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid filters or pagination parameters&quot;, content = @Content),
                    @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Account not found (if you enforce existence check)&quot;, content = @Content)
            }
    )
    @GetMapping(&quot;/accounts/{id}/transactions&quot;)
    public ResponseEntity&lt;Page&lt;TransactionLog&gt;&gt; getTransactionHistory(
            @Parameter(name = &quot;id&quot;, description = &quot;Account ID (string)&quot;, in = ParameterIn.PATH, required = true)
            @PathVariable(&quot;id&quot;) String accountId,

            @Parameter(description = &quot;Start timestamp (inclusive) in ISO-8601, e.g., 2026-02-01T00:00:00Z&quot;)
            @RequestParam(value = &quot;from&quot;, required = false)
            @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)
            OffsetDateTime from,

            @Parameter(description = &quot;End timestamp (inclusive) in ISO-8601, e.g., 2026-02-28T23:59:59Z&quot;)
            @RequestParam(value = &quot;to&quot;, required = false)
            @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)
            OffsetDateTime to,

            @Parameter(description = &quot;Transaction status filter&quot;,
                    schema = @Schema(implementation = TransactionStatus.class))
            @RequestParam(value = &quot;status&quot;, required = false)
            TransactionStatus status,

            @Parameter(description = &quot;Direction filter: ALL (default), SENT, RECEIVED&quot;,
                    schema = @Schema(allowableValues = {&quot;ALL&quot;, &quot;SENT&quot;, &quot;RECEIVED&quot;}))
            @RequestParam(value = &quot;direction&quot;, required = false, defaultValue = &quot;ALL&quot;)
            TransferService.Direction direction,

            @ParameterObject
            @PageableDefault(size = 20, sort = &quot;createdOn,desc&quot;) Pageable pageable
    ) {
<span class="nc" id="L110">        Page&lt;TransactionLog&gt; page = txQueryService.getAccountTransactions(</span>
                accountId, from, to, status, direction, pageable
        );
<span class="nc" id="L113">        return ResponseEntity.ok(page);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>